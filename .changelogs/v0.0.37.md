# v0.0.37

## Changes

- [x] Added: `persistenceMiddleware` for automatic thread load/save across LLM requests
- [x] Added: `PersistenceAdapter` class with `load` and `save` callbacks for custom storage backends
- [x] Added: `getThread()` and `getThreadId()` helpers to retrieve thread from middleware state
- [x] Added: `onTurn` middleware hook for processing completed turns
- [x] Added: `timestamp` option in `MessageOptions` for timestamp override during deserialization
- [x] Changed: `StreamResult.turn` auto-drains the stream if accessed before iteration starts
- [x] Changed: `Thread.fromJSON()` now restores original message timestamps
- [x] Changed: LLM core uses `resolveTurnStartIndex()` for accurate turn slicing with middleware-injected history

## New Feature: Persistence Middleware

Automatically load and save conversation threads across LLM requests. Bring your own storage backend via the adapter pattern.

```ts
import { llm } from '@providerprotocol/ai';
import { anthropic } from '@providerprotocol/ai/anthropic';
import {
  persistenceMiddleware,
  PersistenceAdapter,
} from '@providerprotocol/ai/middleware/persistence';

// Create adapter with your storage backend
const adapter = new PersistenceAdapter({
  id: 'conversation-123',
  load: async (id) => {
    const data = await db.get(id);
    return data ?? null; // Return Thread, ThreadJSON, or null for new conversations
  },
  save: async (id, thread, turn) => {
    await db.set(id, thread.toJSON());
  },
});

// Attach to model
const model = llm({
  model: anthropic('claude-sonnet-4-20250514'),
  middleware: [persistenceMiddleware({ adapter })],
});

// Thread loads automatically, saves after each turn
await model.generate('Hello!');
await model.generate('What did I just say?'); // Has full conversation context
```

Access the thread from middleware state:

```ts
import { getThread, getThreadId } from '@providerprotocol/ai/middleware/persistence';

const analyticsMiddleware: Middleware = {
  name: 'analytics',
  onTurn(turn, ctx) {
    const thread = getThread(ctx.state);
    console.log(`Thread ${getThreadId(ctx.state)} now has ${thread?.messages.length} messages`);
  },
};
```

## Breaking Changes

### New `onTurn` middleware hook

Middleware can now receive the completed `Turn` after LLM execution. Called in reverse middleware order.

```ts
const middleware: Middleware = {
  name: 'analytics',
  onTurn(turn, ctx) {
    console.log(`Turn completed with ${turn.messages.length} messages`);
  },
};
```

## Migration Notes

1. If using `StreamResult.turn` without iterating the stream first, behavior is now auto-drain (no action needed, just be aware)
2. Thread timestamps are now preserved through JSON serialization/deserialization cycles
