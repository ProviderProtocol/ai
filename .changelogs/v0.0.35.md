# v0.0.35

## Changes

- [x] Added: Pub-sub middleware for stream resumption with reconnection support
- [x] Added: Memory adapter for pub-sub with LRU eviction
- [x] Added: Server integrations for pub-sub (WebAPI, Express, Fastify, H3)
- [x] Added: Dedicated middleware entry points (`@providerprotocol/ai/middleware/*`)
- [x] Added: `onAbort` middleware hook for cancellation/early termination
- [x] Fixed: Abort hooks now invoked on early stream termination
- [x] Fixed: Improved partial JSON parsing with better trailing incomplete element handling
- [x] Changed: Middleware exports moved from main entry to dedicated subpaths
- [x] Changed: `ObjectDelta` events now emitted alongside `TextDelta` (not exclusive) for structured output streaming
- [x] Changed: Anthropic emits `ObjectDelta` for `ToolCallDelta` in structured output scenarios
- [x] Removed: Direct middleware exports from `@providerprotocol/ai`
- [x] Docs: Updated middleware documentation in llms.md and README
- [x] Docs: Added Groq and Cerebras provider examples in llms.md
- [x] Docs: Updated provider capability matrix (xAI image input, Ollama image input + structured output)

## Breaking Changes

### Middleware imports moved to dedicated entry points

Middleware is no longer exported from the main package entry. Import from dedicated subpaths instead.

```ts
// Before
import { loggingMiddleware, parsedObjectMiddleware } from '@providerprotocol/ai';

// After
import { loggingMiddleware } from '@providerprotocol/ai/middleware/logging';
import { parsedObjectMiddleware } from '@providerprotocol/ai/middleware/parsed-object';
```

### ObjectDelta streaming behavior change

`ObjectDelta` events are now emitted **alongside** `TextDelta` events for structured output streaming, rather than exclusively. This gives developers explicit hooks for both raw text and structured data.

```ts
// Before: EITHER TextDelta OR ObjectDelta
for await (const event of stream) {
  if (event.type === 'text_delta') { /* only for non-structured */ }
  if (event.type === 'object_delta') { /* only for structured */ }
}

// After: BOTH TextDelta AND ObjectDelta emitted
for await (const event of stream) {
  if (event.type === 'text_delta') { /* always emitted */ }
  if (event.type === 'object_delta') { /* also emitted for structured */ }
}
```

## New Features

### Pub-Sub Middleware

Stream resumption middleware that buffers events and enables reconnecting clients to catch up on missed events during active generation.

```ts
import { llm } from '@providerprotocol/ai';
import { anthropic } from '@providerprotocol/ai/anthropic';
import { pubsubMiddleware, memoryAdapter } from '@providerprotocol/ai/middleware/pubsub';
import { createSubscriberStream } from '@providerprotocol/ai/middleware/pubsub/server/webapi';

const adapter = memoryAdapter({ maxStreams: 1000 });

// Server route handling both new requests and reconnections
export async function POST(req: Request) {
  const { messages, streamId } = await req.json();
  const exists = await adapter.exists(streamId);

  if (!exists) {
    const model = llm({
      model: anthropic('claude-sonnet-4-20250514'),
      middleware: [pubsubMiddleware({ adapter, streamId })],
    });
    consumeInBackground(model.stream(messages));
  }

  return new Response(createSubscriberStream(streamId, adapter), {
    headers: { 'Content-Type': 'text/event-stream' },
  });
}
```

### Framework-Specific Server Handlers

Pre-built handlers for common server frameworks:

```ts
// Express
import { streamSubscriber } from '@providerprotocol/ai/middleware/pubsub/server/express';

// Fastify
import { streamSubscriber } from '@providerprotocol/ai/middleware/pubsub/server/fastify';

// H3 (Nuxt)
import { streamSubscriber } from '@providerprotocol/ai/middleware/pubsub/server/h3';

// Web API (generic)
import { createSubscriberStream } from '@providerprotocol/ai/middleware/pubsub/server/webapi';
```

## Migration Notes

1. Update middleware imports to use dedicated entry points
2. If using custom middleware, no changes needed - the `Middleware` type is unchanged
3. If filtering stream events for structured output, update logic to handle both `TextDelta` and `ObjectDelta` being emitted
