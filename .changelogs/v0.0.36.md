# v0.0.36

## Changes

- [x] Added: `StreamResult` implements `PromiseLike<Turn>` for direct awaiting with auto-drain
- [x] Added: `CompletionCallback` for pub-sub subscriber completion signals
- [x] Changed: Pub-sub `subscribe()` now requires an `onComplete` callback for completion signals
- [x] Changed: Memory adapter uses event-driven completion instead of polling and schedules callbacks via microtasks
- [x] Changed: Server subscriber streams use signal-based waiting instead of 500ms polling
- [x] Changed: Stream cleanup now happens immediately after completion notification (not via periodic cleanup)
- [x] Removed: `ttl` option from `PubSubOptions`
- [x] Removed: `cleanup()` method from `PubSubAdapter` interface
- [x] Removed: Periodic TTL-based cleanup from pub-sub middleware

## Breaking Changes

### StreamResult is now directly awaitable

`StreamResult` implements `PromiseLike<Turn>`, allowing direct `await` on streams. The stream auto-drains when awaited.

```ts
// Before: Must iterate or access .turn
const stream = instance.stream('Tell me a story');
for await (const event of stream) { /* ... */ }
const turn = await stream.turn;

// After: Can await directly (auto-drains stream)
const turn = await instance.stream('Tell me a story');

// Fire-and-forget pattern
instance.stream('Tell me a story').then(turn => saveToDB(turn));
```

### PubSubAdapter.subscribe() signature changed

The `subscribe()` method now requires a completion callback as the third parameter.
Adapters must invoke `onComplete` when `markCompleted()` runs so subscriber streams can terminate.

```ts
// Before
subscribe(streamId: string, callback: SubscriptionCallback): Unsubscribe;

// After
subscribe(
  streamId: string,
  onEvent: SubscriptionCallback,
  onComplete: CompletionCallback
): Unsubscribe;
```

### PubSubAdapter.cleanup() removed

The `cleanup()` method has been removed from the adapter interface. Streams are now removed immediately after completion. If a stream never reaches completion/abort/error hooks (for example, a process crash), adapters may retain the entry.

```ts
// Before
interface PubSubAdapter {
  cleanup(maxAge: number): Promise<void>;
  // ...
}

// After - cleanup is automatic on completion/abort/error
const adapter = memoryAdapter({ maxStreams: 1000 });
```

### PubSubOptions.ttl removed

TTL configuration removed from middleware.

```ts
// Before
pubsubMiddleware({ adapter, streamId, ttl: 600_000 });

// After
const adapter = memoryAdapter();
pubsubMiddleware({ adapter, streamId });
```

## Migration Notes

1. If awaiting `StreamResult` directly, behavior is unchanged - but you can now skip manual iteration for fire-and-forget patterns
2. Custom `PubSubAdapter` implementations must update `subscribe()` signature to require `onComplete`
3. Custom adapters must remove the `cleanup()` method
4. If you need orphan cleanup, implement it in custom adapters (memory adapter relies on LRU only)
