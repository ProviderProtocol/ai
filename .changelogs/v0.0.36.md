# v0.0.36

## Changes

- [x] Added: `StreamResult` implements `PromiseLike<Turn>` for direct awaiting with auto-drain
- [x] Added: `CompletionCallback` for pub-sub subscriber completion signals
- [x] Changed: Pub-sub `subscribe()` now requires an `onComplete` callback for completion signals
- [x] Changed: Memory adapter uses event-driven completion instead of polling and schedules callbacks via microtasks
- [x] Changed: Server subscriber streams use signal-based waiting instead of 500ms polling
- [x] Changed: Streams are created lazily on first `append()` or `subscribe()` call
- [x] Changed: `remove()` now notifies subscribers before deletion (merges old `markCompleted()` behavior)
- [x] Changed: `getEvents()` returns empty array for non-existent streams (not null)
- [x] Removed: `create()` method from `PubSubAdapter` interface (lazy initialization)
- [x] Removed: `markCompleted()` method from `PubSubAdapter` interface (merged into `remove()`)
- [x] Removed: `isCompleted()` method from `PubSubAdapter` interface
- [x] Removed: `getStream()` method from `PubSubAdapter` interface
- [x] Removed: `onRequest` hook from pubsubMiddleware (streams created lazily)
- [x] Removed: `modelId`, `provider`, `completed` fields from `StoredStream`
- [x] Removed: `ttl` option from `PubSubOptions`
- [x] Removed: `cleanup()` method from `PubSubAdapter` interface
- [x] Removed: Periodic TTL-based cleanup from pub-sub middleware

## Breaking Changes

### StreamResult is now directly awaitable

`StreamResult` implements `PromiseLike<Turn>`, allowing direct `await` on streams. The stream auto-drains when awaited.

```ts
// Before: Must iterate or access .turn
const stream = instance.stream('Tell me a story');
for await (const event of stream) { /* ... */ }
const turn = await stream.turn;

// After: Can await directly (auto-drains stream)
const turn = await instance.stream('Tell me a story');

// Fire-and-forget pattern
instance.stream('Tell me a story').then(turn => saveToDB(turn));
```

### PubSubAdapter interface significantly simplified

The adapter interface has been reduced to essential operations only. Streams are lazily created on first use.

```ts
// Before
interface PubSubAdapter {
  exists(streamId: string): Promise<boolean>;
  create(streamId: string, metadata: { modelId: string; provider: string }): Promise<void>;
  append(streamId: string, event: StreamEvent): Promise<void>;
  markCompleted(streamId: string): Promise<void>;
  isCompleted(streamId: string): Promise<boolean>;
  getEvents(streamId: string): Promise<StreamEvent[] | null>;
  getStream(streamId: string): Promise<StoredStream | null>;
  subscribe(streamId: string, onEvent: SubscriptionCallback, onComplete: CompletionCallback): Unsubscribe;
  publish(streamId: string, event: StreamEvent): void;
  remove(streamId: string): Promise<void>;
}

// After
interface PubSubAdapter {
  exists(streamId: string): Promise<boolean>;
  append(streamId: string, event: StreamEvent): Promise<void>;  // Creates lazily
  getEvents(streamId: string): Promise<StreamEvent[]>;          // Returns [] not null
  subscribe(streamId: string, onEvent: SubscriptionCallback, onComplete: CompletionCallback): Unsubscribe;  // Creates lazily
  publish(streamId: string, event: StreamEvent): void;
  remove(streamId: string): Promise<void>;                       // Notifies subscribers then removes
}
```

### StoredStream simplified

Metadata fields removed since pub-sub only stores in-flight streams.

```ts
// Before
interface StoredStream {
  readonly streamId: string;
  readonly modelId: string;
  readonly provider: string;
  readonly createdAt: number;
  readonly updatedAt: number;
  readonly completed: boolean;
  readonly events: readonly StreamEvent[];
}

// After
interface StoredStream {
  readonly streamId: string;
  readonly createdAt: number;
  readonly events: readonly StreamEvent[];
}
```

### markCompleted() merged into remove()

Stream completion and removal are now a single operation. Call `remove()` to notify subscribers and delete the stream.

```ts
// Before
await adapter.markCompleted(streamId);  // Notify subscribers
await adapter.remove(streamId);         // Delete stream

// After
await adapter.remove(streamId);  // Notifies subscribers then deletes
```

### PubSubOptions.ttl removed

TTL configuration removed from middleware.

```ts
// Before
pubsubMiddleware({ adapter, streamId, ttl: 600_000 });

// After
const adapter = memoryAdapter();
pubsubMiddleware({ adapter, streamId });
```

## Migration Notes

1. If awaiting `StreamResult` directly, behavior is unchanged - but you can now skip manual iteration for fire-and-forget patterns
2. Custom `PubSubAdapter` implementations must remove:
   - `create()` - streams are created lazily on `append()` or `subscribe()`
   - `markCompleted()` - merge into `remove()` to notify then delete
   - `isCompleted()` - no longer needed
   - `getStream()` - no longer needed
3. Update `getEvents()` to return `[]` instead of `null` for non-existent streams
4. Subscriber streams wait for completion via `onComplete` callback triggered by `remove()`
5. If you need orphan cleanup, implement it in custom adapters (memory adapter throws when `maxStreams` exceeded)
