# v0.0.31 Changelog

## Security Utilities

- [x] `warnInsecureUrl()` - warns when using non-TLS URLs (dev only, excludes localhost)
- [x] `maskApiKey()` - masks API keys for safe logging (`sk-abc...xyz9`)

```ts
import { warnInsecureUrl, maskApiKey } from '@providerprotocol/ai/http';

// Warns in dev when using http:// URLs (security risk)
warnInsecureUrl('http://api.example.com', 'custom');

// Safe logging
console.log(`Using key: ${maskApiKey('sk-abc123def456xyz789')}`);
// Output: "Using key: sk-a...z789"
```

## Embedding Input Type Hints

- [x] New `EmbeddingInputType` enum: `'document'` | `'query'`
- [x] New `inputType` option in `EmbedOptions` for provider-specific optimization

```ts
import { embed, EmbeddingInputType } from '@providerprotocol/ai';

// Optimize for document storage
const docEmbedding = await embed({
  model: google('text-embedding-004'),
  input: 'Document content here...',
  options: { inputType: EmbeddingInputType.Document }
});

// Optimize for query/search
const queryEmbedding = await embed({
  model: google('text-embedding-004'),
  input: 'search query',
  options: { inputType: EmbeddingInputType.Query }
});
```

## Breaking Changes

### Metadata Namespacing (Spec 15.4)

Provider-specific metadata is now namespaced under the provider key to prevent collisions and clarify ownership.

**Embedding responses:**

```ts
// Before
result.metadata?.truncated        // Google
result.metadata?.totalDuration    // Ollama
result.metadata?.cost             // OpenRouter

// After
result.metadata?.google?.truncated
result.metadata?.ollama?.totalDuration
result.metadata?.openrouter?.cost
```

**Image responses:**

```ts
// Before
image.metadata?.revised_prompt    // OpenAI, xAI

// After
image.metadata?.openai?.revised_prompt
image.metadata?.xai?.revised_prompt
```

**Affected providers:**
- Google Embed: `truncated` → `google.truncated`
- Ollama Embed: `totalDuration`, `loadDuration` → `ollama.totalDuration`, `ollama.loadDuration`
- OpenRouter Embed: `cost` → `openrouter.cost`
- OpenAI Image: `revised_prompt` → `openai.revised_prompt`
- xAI Image: `revised_prompt` → `xai.revised_prompt`

## Tests

- [x] `tests/unit/http/fetch.test.ts` - `warnInsecureUrl()` tests
- [x] `tests/unit/http/keys.test.ts` - `maskApiKey()` tests
- [x] `tests/unit/http/retry.test.ts` - retry strategy tests
- [x] `tests/unit/providers/metadata-namespacing.test.ts` - metadata namespace tests
