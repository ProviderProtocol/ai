# v0.0.32 Changelog

## Partial JSON Streaming

- [x] New `parsePartialJson()` utility for incremental JSON parsing during streaming
- [x] New `parsedObjectMiddleware()` - middleware for automatic partial JSON parsing
- [x] New `ObjectDelta` stream event type for structured output responses
- [x] `objectDelta()` helper for creating object delta events

### Partial JSON Parser

Parses incomplete JSON strings as they stream in, extracting usable partial objects:

```ts
import { parsePartialJson } from '@providerprotocol/ai/utils/partial-json';

// Complete JSON
parsePartialJson('{"name":"John"}');
// => { value: { name: "John" }, isComplete: true }

// Incomplete object (mid-stream)
parsePartialJson('{"user":{"firstName":"Jo');
// => { value: { user: { firstName: "Jo" } }, isComplete: false }

// Incomplete array
parsePartialJson('[1, 2, 3');
// => { value: [1, 2, 3], isComplete: false }
```

### Parsed Object Middleware

Automatically parses streaming JSON from `ObjectDelta` and `ToolCallDelta` events:

```ts
import { llm, parsedObjectMiddleware, StreamEventType } from '@providerprotocol/ai';
import { anthropic } from '@providerprotocol/ai/anthropic';

const model = llm({
  model: anthropic('claude-sonnet-4-20250514'),
  structure: {
    type: 'object',
    properties: {
      city: { type: 'string' },
      country: { type: 'string' },
      population: { type: 'number' },
    },
    required: ['city', 'country', 'population'],
  },
  middleware: [parsedObjectMiddleware()],
});

for await (const event of model.stream('What is the capital of France?')) {
  if (event.type === StreamEventType.ObjectDelta) {
    // Access incrementally parsed structured data
    console.log(event.delta.parsed);
    // { city: "Par" } -> { city: "Paris" } -> { city: "Paris", country: "Fr" } -> ...
  }
}
```

### Tool Call Argument Parsing

Also works with tool call streaming - arguments are parsed incrementally:

```ts
for await (const event of model.stream('What is 7 times 8?')) {
  if (event.type === StreamEventType.ToolCallDelta) {
    console.log(event.delta.parsed);
    // { a: 7 } -> { a: 7, b: 8 }
  }
}
```

## Middleware Options

```ts
parsedObjectMiddleware({
  parseObjects: true,     // Parse ObjectDelta events (default: true)
  parseToolCalls: true,   // Parse ToolCallDelta events (default: true)
});
```

## Tests

- [x] `tests/unit/utils/partial-json.test.ts` - Partial JSON parser unit tests
- [x] `tests/unit/types/stream.test.ts` - Stream type tests including `objectDelta`
- [x] `tests/live/partial-json-streaming.live.test.ts` - Live API tests across all providers
